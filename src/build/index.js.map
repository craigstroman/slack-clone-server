{"version":3,"sources":["../index.js"],"names":["require","config","PORT","process","env","SECRET1","SECRET2","graphqlEndpoint","GRAPHQL_ENDPOINT","subscriptionEndpoint","SUBSCRIPTION_ENDPOINT","graphql","subscriptions","reactApp","NODE_ENV","app","set","path","join","__dirname","use","express","all","req","res","next","header","HOST","routes","locals","title","content","apolloServer","ApolloServer","schema","playground","context","token","headers","jwt","verify","user","models","err","console","log","applyMiddleware","server","listen","port","SubscriptionServer","execute","subscribe","onConnect","connectionParams","webSocket","refreshToken","newTokens","reconnect"],"mappings":"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","sourcesContent":["import path from 'path';\nimport express from 'express';\nimport { createServer } from 'http';\nimport { ApolloServer } from 'apollo-server-express';\nimport { SubscriptionServer } from 'subscriptions-transport-ws';\nimport { execute, subscribe } from 'graphql';\nimport jwt from 'jsonwebtoken';\nimport cors from 'cors';\nimport { refreshTokens } from './auth';\nimport routes from './routes/index';\nimport models from './models/index';\nimport schema from './schema';\n\nrequire('dotenv').config();\n\nconst PORT = process.env.PORT || 3000;\nconst SECRET1 = process.env.SECRET1;\nconst SECRET2 = process.env.SECRET2;\nconst graphqlEndpoint = process.env.GRAPHQL_ENDPOINT;\nconst subscriptionEndpoint = process.env.SUBSCRIPTION_ENDPOINT;\nconst graphql = `http://localhost:${PORT}${graphqlEndpoint}`;\nconst subscriptions = `ws://localhost:${PORT}${subscriptionEndpoint}`;\nconst reactApp = process.env.NODE_ENV === 'development' ? '/static/js/bundle.js' : '/static/js/main.min.js';\n\nconst app = express();\n\napp.set('views', path.join(__dirname, './views'));\napp.set('view engine', 'pug');\n\napp.use('/static', express.static('public'));\n\napp.use(cors());\napp.all('/', function (req, res, next) {\n  res.header('Access-Control-Allow-Origin', process.env.HOST);\n  res.header('Access-Control-Allow-Headers', 'X-Requested-With');\n  next();\n});\n\napp.use(routes);\n\napp.locals.title = 'Slack Clone';\napp.locals.content = 'A Slack clone using Express, GarphQL, and React.';\napp.locals.reactApp = reactApp;\napp.locals.env = process.env;\n\nconst apolloServer = new ApolloServer({\n  schema,\n  playground:\n    process.env.NODE_ENV === 'development'\n      ? {\n          graphqlEndpoint,\n        }\n      : false,\n  context: ({ req }) => {\n    const token = req.headers['x-token'] || null;\n\n    if (token) {\n      try {\n        const { user } = jwt.verify(token, SECRET1);\n\n        return {\n          models,\n          user,\n          SECRET1,\n          SECRET2,\n        };\n      } catch (err) {\n        console.log('error: ');\n        console.log('err: ', err);\n      }\n    }\n    return {\n      models,\n      SECRET1,\n      SECRET2,\n    };\n  },\n});\n\napolloServer.applyMiddleware({ app });\nconst server = createServer(app);\n\nserver.listen({ port: PORT }, () => {\n  console.log(`ðŸš€ Server ready at ${graphql}`);\n  console.log(`ðŸš€ Subscriptions ready at ${subscriptions}`);\n\n  new SubscriptionServer(\n    {\n      execute,\n      subscribe,\n      schema,\n      onConnect: async (connectionParams, webSocket) => {\n        const { token, refreshToken } = connectionParams;\n\n        if (token && refreshToken) {\n          try {\n            const { user } = jwt.verify(token, SECRET1);\n\n            return { user, models };\n          } catch (err) {\n            const newTokens = await refreshTokens(token, refreshToken, models, SECRET1, SECRET2);\n\n            return { user: newTokens.user, models };\n          }\n        }\n\n        return { models };\n      },\n      reconnect: true,\n    },\n    {\n      server,\n      reconnect: true,\n      path: '/subscriptions',\n    },\n  );\n});\n"],"file":"index.js"}