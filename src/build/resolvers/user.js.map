{"version":3,"sources":["../../resolvers/user.js"],"names":["User","teams","parent","args","models","user","sequelize","query","replacements","id","model","Team","raw","Query","allUsers","findAll","me","requiresAuth","createResolver","findOne","where","verifyEmail","email","result","console","log","verifyUser","username","Mutation","login","password","SECRET1","SECRET2","loginResult","team","channelUUID","ok","userInfo","undefined","Channels","channel","uuid","Array","isArray","length","teamUUID","token","refreshToken","register","shortid","generate","create","errors","updateProfile","firstName","lastName","phoneNumber"],"mappings":"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","sourcesContent":["import { tryLogin } from '../auth';\nimport formatErrors from '../formatErrors';\nimport requiresAuth from '../permissions';\nimport shortid from 'shortid';\n\nexport default {\n  User: {\n    /**\n     * Get's the teams.\n     *\n     * @param      {Object}  parent       The parent.\n     * @param      {Object}  args         The arguments.\n     * @param      {Object}  models       The models.\n     * @param      {Object}  user         The user.\n     */\n    teams: (parent, args, { models, user }) =>\n      models.sequelize.query(\n        'select * from teams as team join members as member on team.id = member.team_id where member.user_id = ?',\n        {\n          replacements: [user.id],\n          model: models.Team,\n          raw: true,\n        },\n      ),\n  },\n  Query: {\n    /**\n     * Get's all users.\n     *\n     * @param      {Object}  parent       The parent.\n     * @param      {Object}  args         The arguments.\n     * @param      {Object}  models       The models.\n     */\n    allUsers: (parent, args, { models }) => models.User.findAll(),\n    /**\n     * Get's the logged in user information.\n     *\n     * @param      {Object}  parent       The parent.\n     * @param      {Object}  args         The arguments.\n     * @param      {Object}  user         The user.\n     * @param      {Object}  models       The models.\n     */\n    me: requiresAuth.createResolver((parent, args, { user, models }) =>\n      models.User.findOne({ where: { id: user.id } }),\n    ),\n    verifyEmail: async (parent, args, { models }) => {\n      try {\n        const { email } = args;\n        const result = await models.User.findOne({ where: { email: email } }, { raw: true });\n\n        if (result !== null) {\n          if (email === result.email) {\n            return true;\n          }\n        }\n\n        return false;\n      } catch (err) {\n        console.log(`There was an error: ${err}`);\n\n        return false;\n      }\n    },\n    /**\n     * Verify's if a user exists or not.\n     *\n     * @param      {Object}   parent       The parent\n     * @param      {Object}   args         The arguments\n     * @param      {Object}   models       The models\n     * @return     {boolean}  { description_of_the_return_value }\n     */\n    verifyUser: async (parent, args, { models }) => {\n      try {\n        const { username } = args;\n        const result = await models.User.findOne({ where: { username: username } }, { raw: true });\n\n        if (result !== null) {\n          if (username === result.username) {\n            return true;\n          }\n        }\n\n        return false;\n      } catch (err) {\n        console.log(`There was an error: ${err}`);\n\n        return false;\n      }\n    },\n  },\n  Mutation: {\n    /**\n     * Logs a user in.\n     *\n     * @param      {Object}  parent         The parent\n     * @param      {String}  email          The email.\n     * @param      {String}  password       The password.\n     * @param      {Object}  models         The models.\n     * @param      {String}  SECRET         The secret.\n     * @param      {String}  SECRET2        The secret 2.\n     */\n    login: async (parent, { email, password }, { models, SECRET1, SECRET2 }) => {\n      const loginResult = await tryLogin(email, password, models, SECRET1, SECRET2);\n      let result = null;\n      let teams = null;\n      let team = null;\n      let channelUUID = null;\n\n      if (loginResult.ok) {\n        try {\n          teams = await models.sequelize.query(\n            'select * from teams as team join members as member on team.id = member.team_id where member.user_id = ?',\n            {\n              replacements: [loginResult.userInfo.id],\n              model: models.Team,\n              raw: true,\n            },\n          );\n\n          team = teams[0];\n\n          if (team !== undefined) {\n            const channel = await models.sequelize.query(\n              \"select uuid from channels where channels.name = 'general' and channels.team_id = ?\",\n              {\n                replacements: [team.id],\n                model: models.Channels,\n                raw: true,\n              },\n            );\n\n            channelUUID = channel[0][0].uuid;\n          } else {\n            console.log('No teams.');\n            teams = [];\n            team = '';\n            channelUUID = '';\n          }\n        } catch (err) {\n          console.log(`There was an error: ${err}`);\n\n          teams = [];\n          team = '';\n          channelUUID = '';\n        }\n\n        if (Array.isArray(teams)) {\n          if (teams.length >= 1) {\n            result = {\n              ok: loginResult.ok,\n              user: loginResult.user,\n              teamUUID: team.uuid,\n              channelUUID: channelUUID,\n              token: loginResult.token,\n              refreshToken: loginResult.refreshToken,\n            };\n          } else {\n            result = {\n              ok: loginResult.ok,\n              user: loginResult.user,\n              teamUUID: undefined,\n              token: loginResult.token,\n              refreshToken: loginResult.refreshToken,\n            };\n          }\n        } else {\n          result = {\n            ok: loginResult.ok,\n            user: loginResult.user,\n            teamUUID: undefined,\n            token: loginResult.token,\n            refreshToken: loginResult.refreshToken,\n          };\n        }\n      } else {\n        result = {\n          ok: loginResult.ok,\n          user: loginResult.user,\n          teamUUID: undefined,\n          token: loginResult.token,\n          refreshToken: loginResult.refreshToken,\n        };\n      }\n\n      return result;\n    },\n    /**\n     * Registers a user.\n     *\n     * @param      {Object}  parent       The parent.\n     * @param      {Object}  args         The arguments.\n     * @param      {Object}  models       The models.\n     */\n    register: async (parent, args, { models }) => {\n      try {\n        args['uuid'] = shortid.generate();\n\n        const user = await models.User.create(args);\n\n        return {\n          ok: true,\n          user,\n        };\n      } catch (err) {\n        return {\n          ok: false,\n          errors: formatErrors(err, models),\n        };\n      }\n    },\n    updateProfile: async (parent, args, { models }) => {\n      const { id, username, firstName, lastName, phoneNumber } = args;\n\n      try {\n        await models.sequelize.query(\n          'update users set username = ?, first_name = ?, last_name = ?, phone_number = ? where id = ?',\n          {\n            replacements: [username, firstName, lastName, phoneNumber, id],\n            model: models.User,\n            raw: true,\n          },\n        );\n\n        return {\n          ok: true,\n        };\n      } catch (err) {\n        return {\n          ok: false,\n          errors: formatErrors(err, models),\n        };\n      }\n    },\n  },\n};\n"],"file":"user.js"}