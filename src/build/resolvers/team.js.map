{"version":3,"sources":["../../resolvers/team.js"],"names":["Query","getTeamMembers","requiresAuth","createResolver","parent","teamId","models","sequelize","query","replacements","model","User","raw","Mutation","addTeamMember","email","user","memberPromise","Member","findOne","where","userId","id","userToAddPromise","Promise","all","member","userToAdd","admin","ok","errors","path","message","create","console","log","createTeam","args","teamName","name","owner","Team","teamExists","Array","isArray","length","transaction","shortid","generate","team","Channel","uuid","channel","channelUUID","response","channels","findAll","directMessageMembers","currentUserId","teamMembers"],"mappings":"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","sourcesContent":["import formatErrors from '../formatErrors';\nimport requiresAuth from '../permissions';\nimport shortid from 'shortid';\nimport team from '../models/team';\n\nexport default {\n  Query: {\n    /**\n     * Get's the team members.\n     *\n     * @param      {Object}  parent       The parent.\n     * @param      {number}  teamId       The teamId.\n     * @param      {Object}  models       The models.\n     */\n    getTeamMembers: requiresAuth.createResolver(async (parent, { teamId }, { models }) => {\n      return models.sequelize.query(\n        'select * from users as u join members as m on m.user_id = u.id where m.team_id = ?',\n        {\n          replacements: [teamId],\n          model: models.User,\n          raw: true,\n        },\n      );\n    }),\n  },\n  Mutation: {\n    /**\n     * Allows a user to invite a user to a team.\n     *\n     * @param      {Object}  parent       The parent.\n     * @param      {String}  email        The email.\n     * @param      {number}  teamId       The teamId.\n     * @param      {Object}  models       The models.\n     * @param      {Object}  user         The user.\n     */\n    addTeamMember: requiresAuth.createResolver(async (parent, { email, teamId }, { models, user }) => {\n      try {\n        const memberPromise = models.Member.findOne({ where: { teamId, userId: user.id } }, { raw: true });\n        const userToAddPromise = models.User.findOne({ where: { email } }, { raw: true });\n        const [member, userToAdd] = await Promise.all([memberPromise, userToAddPromise]);\n        if (!member.admin) {\n          return {\n            ok: false,\n            errors: [{ path: 'email', message: 'You cannot add members to the team' }],\n          };\n        }\n        if (!userToAdd) {\n          return {\n            ok: false,\n            errors: [{ path: 'email', message: 'Could not find user with this email' }],\n          };\n        }\n        await models.Member.create({ userId: userToAdd.id, teamId });\n        return {\n          ok: true,\n        };\n      } catch (err) {\n        console.log(err);\n        return {\n          ok: false,\n          errors: formatErrors(err, models),\n        };\n      }\n    }),\n    /**\n     * Creates a team.\n     *\n     * @param      {Object}  parent       The parent.\n     * @param      {Object}  args         The args.\n     * @param      {Object}  models       The models.\n     * @param      {Object}  user         The user.\n     */\n    createTeam: requiresAuth.createResolver(async (parent, args, { models, user }) => {\n      try {\n        const teamName = args['name'];\n        const teamExists = await models.sequelize.query(\n          'select * from teams where name = :name and owner = :owner',\n          {\n            replacements: { name: teamName, owner: user.id },\n            model: models.Team,\n            raw: true,\n          },\n        );\n\n        if (Array.isArray(teamExists)) {\n          if (!teamExists.length) {\n            const response = await models.sequelize.transaction(async () => {\n              args['uuid'] = shortid.generate();\n              args['channelUUID'] = '';\n\n              const team = await models.Team.create({ ...args, owner: user.id });\n\n              const channel = await models.Channel.create({\n                uuid: shortid.generate(),\n                name: 'general',\n                public: true,\n                teamId: team.id,\n              });\n\n              team.channelUUID = channel.uuid;\n\n              await models.Member.create({ teamId: team.id, userId: user.id, admin: true });\n\n              return team;\n            });\n\n            return {\n              ok: true,\n              team: response,\n              channelUUID: response.channelUUID,\n            };\n          }\n        }\n\n        throw 'Team name already exists.';\n      } catch (err) {\n        console.log(err);\n        return {\n          ok: false,\n          errors: formatErrors(err, models),\n        };\n      }\n    }),\n  },\n  Team: {\n    channels: ({ id }, args, { models }) => models.Channel.findAll({ where: { teamId: id } }),\n    directMessageMembers: ({ id }, args, { models, user }) => {\n      return models.sequelize.query(\n        'select distinct on (u.id) u.id, u.uuid, u.username from users as u join direct_messages as dm on (u.id = dm.sender_id) or (u.id = dm.receiver_id) where (:currentUserId = dm.sender_id or :currentUserId = dm.receiver_id) and dm.team_id = :teamId',\n        {\n          replacements: { currentUserId: user.id, teamId: id },\n          model: models.User,\n          raw: true,\n        },\n      );\n    },\n    teamMembers: ({ id }, args, { models, user }) => {\n      return models.sequelize.query(\n        'select u.id, u.uuid, u.username from users as u join members as m on m.user_id = u.id where m.team_id = ?',\n        {\n          replacements: [id],\n          model: models.User,\n          raw: true,\n        },\n      );\n    },\n  },\n};\n"],"file":"team.js"}