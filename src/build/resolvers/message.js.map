{"version":3,"sources":["../../resolvers/message.js"],"names":["pubsub","PubSub","NEW_CHANNEL_MESSAGE","Subscription","newChannelMessage","subscribe","requiresTeamAccess","createResolver","asyncIterator","payload","args","channelId","Message","user","userId","models","User","findOne","where","id","raw","Query","messages","requiresAuth","parent","findAll","order","Mutation","createMessage","create","message","asyncFunc","currentUser","publish","dataValues","console","log"],"mappings":"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","sourcesContent":["import { PubSub, withFilter } from 'graphql-subscriptions';\nimport requiresAuth, { requiresTeamAccess } from '../permissions';\n\nconst pubsub = new PubSub();\n\nconst NEW_CHANNEL_MESSAGE = 'NEW_CHANNEL_MESSAGE';\n\nexport default {\n  Subscription: {\n    newChannelMessage: {\n      subscribe: requiresTeamAccess.createResolver(\n        withFilter(\n          () => pubsub.asyncIterator(NEW_CHANNEL_MESSAGE),\n          (payload, args) => payload.channelId === args.channelId,\n        ),\n      ),\n    },\n  },\n  Message: {\n    user: ({ user, userId }, args, { models }) => {\n      if (user) {\n        return user;\n      }\n\n      return models.User.findOne({ where: { id: userId } }, { raw: true });\n    },\n  },\n  Query: {\n    messages: requiresAuth.createResolver(async (parent, { channelId }, { models }) =>\n      models.Message.findAll({ order: [['created_at', 'ASC']], where: { channelId } }, { raw: true }),\n    ),\n  },\n  Mutation: {\n    createMessage: requiresAuth.createResolver(async (parent, args, { models, user }) => {\n      try {\n        const message = await models.Message.create({\n          ...args,\n          userId: user.id,\n        });\n\n        const asyncFunc = async () => {\n          const currentUser = await models.User.findOne({\n            where: {\n              id: user.id,\n            },\n          });\n\n          pubsub.publish(NEW_CHANNEL_MESSAGE, {\n            channelId: args.channelId,\n            newChannelMessage: {\n              ...message.dataValues,\n              user: currentUser.dataValues,\n            },\n          });\n        };\n\n        asyncFunc();\n\n        return true;\n      } catch (err) {\n        console.log(err);\n        return false;\n      }\n    }),\n  },\n};\n"],"file":"message.js"}